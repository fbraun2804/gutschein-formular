<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gutschein bestellen</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 2rem auto; padding: 0 1rem; }
    form { display: grid; gap: 1rem; }
    label { display: grid; gap: 0.35rem; }
    input, select, textarea { padding: .6rem; font-size: 1rem; }
    button { padding: .75rem 1rem; font-size: 1rem; cursor: pointer; }
    #out { white-space: pre-wrap; background: #f6f6f6; padding: .75rem; border-radius: .5rem; display:none; }
    .err { color:#b00020 }
    .ok { color:#0a7d00 }
  </style>
</head>
<body>
  <h1>Gutschein bestellen (Test)</h1>

  <form id="f" novalidate>
    <label>
      Gutschein-Artikel-ID (Tabelle 1135)
      <input type="number" name="artikel_id" required placeholder="z. B. 1" />
    </label>

    <label>
      Anzahl
      <input type="number" name="anzahl" value="1" min="1" max="50" required />
    </label>

    <label>
      Betrag (nur bei „Wählbarer Betrag“ nötig)
      <input type="number" name="betrag" step="0.01" placeholder="z. B. 50.00" />
    </label>

    <label>
      Ihre E-Mail
      <input type="email" name="email" required />
    </label>

    <label>
      Ihr Name (optional)
      <input type="text" name="name" />
    </label>

    <label>
      Nachricht an Empfänger (optional)
      <textarea name="message_to_recipient" rows="3"></textarea>
    </label>

    <label style="display:flex; gap:.5rem; align-items:center">
      <input type="checkbox" name="agb" required />
      <span>Ich akzeptiere die AGB.</span>
    </label>

    <label>
      Währung
      <select name="waehrung">
        <option value="EUR" selected>EUR</option>
      </select>
    </label>

    <button type="submit">Jetzt bezahlen (Test)</button>
  </form>

  <div id="out"></div>

  <script>
    const ENDPOINT = "https://vouchers-backend.f-braun.workers.dev/vouchers/order";
    const form = document.getElementById("f");
    const out  = document.getElementById("out");

    function show(msg, ok=false){
      out.style.display = "block";
      out.className = ok ? "ok" : "err";
      out.textContent = typeof msg === "string" ? msg : JSON.stringify(msg, null, 2);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      out.style.display = "none";

      const fd = new FormData(form);
      const payload = {
        artikel_id: Number(fd.get("artikel_id")),
        anzahl:     Number(fd.get("anzahl")),
        betrag:     fd.get("betrag") ? Number(fd.get("betrag")) : null,
        email:      String(fd.get("email") || "").trim(),
        name:       String(fd.get("name") || "").trim(),
        agb:        fd.get("agb") ? true : false,
        message_to_recipient: String(fd.get("message_to_recipient") || "").trim(),
        waehrung:   String(fd.get("waehrung") || "EUR").trim(),
      };

      // einfache Client-Checks
      if(!payload.artikel_id || !payload.anzahl || !payload.email || !payload.agb){
        show("Bitte Artikel-ID, Anzahl, E-Mail und AGB prüfen."); return;
      }

      try{
        const res = await fetch(ENDPOINT, {
          method: "POST",
          mode: "cors",
          headers: { "Content-Type": "application/json" },
          credentials: "omit",
          body: JSON.stringify(payload),
          redirect: "follow",
        });

        const text = await res.text().catch(()=> "");
        // zeige Rohantwort bei Fehler
        if(!res.ok){
          try { show(JSON.parse(text)); } catch { show(text || `${res.status} ${res.statusText}`); }
          return;
        }

        let data = null;
        try { data = JSON.parse(text); } catch {}
        if(!data || !data.redirectUrl){ show("Unerwartete Antwort – keine redirectUrl."); return; }

        // success anzeigen & weiterleiten
        show({info:"Weiterleitung zu Mollie…", redirectUrl: data.redirectUrl}, true);
        window.location.href = data.redirectUrl;
      }catch(err){
        console.error(err);
        show("Netzwerkfehler – bitte später erneut versuchen.");
      }
    });
  </script>
</body>
</html>
