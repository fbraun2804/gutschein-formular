<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Gutschein bestellen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; background:#fafafa; color:#222; }
    form { max-width: 760px; margin:auto; display: grid; gap: 14px; }
    fieldset { border: 1px solid #e5e5e5; padding: 14px; border-radius: 10px; background:#fff; }
    legend { font-weight: 700; padding:0 6px; }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 8px; background:#fff; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .hint { color: #666; font-size: 0.9em; }
    .success { background:#e8f6ec; border:1px solid #b7e1c0; color:#20643a; padding:10px; border-radius:8px; }
    .error { background:#fdecea; border:1px solid #f5c2c0; color:#8a1f17; padding:10px; border-radius:8px; }
    button { padding: 12px 16px; border-radius: 10px; border: none; background: #0b6; color: white; font-weight: 700; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>Gutschein bestellen</h1>
  <p class="hint">Dieses Formular sendet Bestellungen an deinen Cloudflare-Worker. Der Worker speichert in Baserow und erstellt die Zahlung bei Mollie.</p>

  <form id="orderForm" novalidate>
    <fieldset>
      <legend>Gutschein</legend>

      <label for="gutscheinart_id">Gutscheinart</label>
      <select id="gutscheinart_id" name="gutscheinart_id" required>
        <!-- üëâ Trage hier deine echten IDs/Namen aus ‚ÄûGutscheinarten (Tabelle 1135)‚Äú ein -->
        <option value="">Bitte w√§hlen‚Ä¶</option>
        <option value="1">Gutschein (ID 1 ‚Äì Festbetrag)</option>
        <!-- Beispiel f√ºr frei w√§hlbar:
        <option value="999">Wertgutschein (frei w√§hlbar, ID 999)</option>
        -->
      </select>

      <div id="betragBlock" style="display:none; margin-top:8px;">
        <label for="betrag_gewaehlt">Betrag (bei ‚ÄûWertgutschein‚Äú)</label>
        <input type="number" step="0.01" min="1" id="betrag_gewaehlt" name="betrag_gewaehlt" placeholder="z. B. 50.00" />
        <div class="hint">Nur n√∂tig bei Gutscheinart ‚ÄûWertgutschein (frei)‚Äú.</div>
      </div>

      <label for="anzahl" style="margin-top:8px;">Anzahl</label>
      <input type="number" id="anzahl" name="anzahl" min="1" value="1" required />
    </fieldset>

    <fieldset>
      <legend>K√§ufer</legend>
      <div class="row">
        <div>
          <label for="kaeufer_name">Name</label>
          <input type="text" id="kaeufer_name" name="k√§ufer_name" required />
        </div>
        <div>
          <label for="kaeufer_email">E-Mail</label>
          <input type="email" id="kaeufer_email" name="k√§ufer_email" required />
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Empf√§nger</legend>
      <div class="row">
        <div>
          <label for="empfaenger_name">Name</label>
          <input type="text" id="empfaenger_name" name="empf√§nger_name" required />
        </div>
        <div>
          <label for="empfaenger_email">E-Mail (optional)</label>
          <input type="email" id="empfaenger_email" name="empf√§nger_email" />
        </div>
      </div>
      <label for="nachricht" style="margin-top:8px;">Nachricht an Empf√§nger (optional)</label>
      <textarea id="nachricht" name="nachricht_an_empf√§nger" rows="3" placeholder="Ihre pers√∂nliche Widmung ‚Ä¶"></textarea>

      <label style="margin-top:8px;">
        <input type="checkbox" id="agb" required />
        Ich habe die <a href="/agb.html" target="_blank" rel="noopener">AGB</a> gelesen und akzeptiert.
      </label>
    </fieldset>

    <button type="submit" id="submitBtn">Zur Zahlung</button>
    <div id="result" aria-live="polite" style="margin-top:10px;"></div>
  </form>

  <script>
    // ‚úÖ Deine √∂ffentliche Worker-URL:
    const WORKER_ORDER_URL = "https://vouchers-backend.f-braun.workers.dev/vouchers/order";

    // Ein-/Ausblenden des Betragsfeldes (heuristisch: wenn "frei" im Namen vorkommt)
    const artSelect = document.getElementById('gutscheinart_id');
    const betragBlock = document.getElementById('betragBlock');
    artSelect.addEventListener('change', () => {
      const txt = artSelect.options[artSelect.selectedIndex]?.text?.toLowerCase() || "";
      betragBlock.style.display = (txt.includes('frei') || txt.includes('w√§hlbar')) ? 'block' : 'none';
    });

    const form = document.getElementById('orderForm');
    const result = document.getElementById('result');
    const submitBtn = document.getElementById('submitBtn');
    function show(msg, cls) { result.innerHTML = '<div class="'+cls+'">'+msg+'</div>'; }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      result.innerHTML = "";
      submitBtn.disabled = true;

      const payload = {
        gutscheinart_id: Number(document.getElementById('gutscheinart_id').value),
        betrag_gewaehlt: document.getElementById('betrag_gewaehlt').value ? Number(document.getElementById('betrag_gewaehlt').value) : undefined,
        anzahl: Number(document.getElementById('anzahl').value),
        "k√§ufer_name": document.getElementById('kaeufer_name').value.trim(),
        "k√§ufer_email": document.getElementById('kaeufer_email').value.trim(),
        "empf√§nger_name": document.getElementById('empfaenger_name').value.trim(),
        "empf√§nger_email": document.getElementById('empfaenger_email').value.trim() || undefined,
        "nachricht_an_empf√§nger": document.getElementById('nachricht').value.trim() || undefined,
        agbAccepted: document.getElementById('agb').checked
      };

      if (!payload.gutscheinart_id) { show("Bitte eine Gutscheinart w√§hlen.", "error"); submitBtn.disabled = false; return; }

      try {
        const res = await fetch(WORKER_ORDER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let json; try { json = JSON.parse(text); } catch { json = { raw: text }; }

        if (!res.ok || json.ok === false) {
          show("<strong>Fehler:</strong> " + (json?.error || (res.status + " " + res.statusText)), "error");
        } else if (json.redirectUrl) {
          // Weiterleitung zu Mollie
          window.location.href = json.redirectUrl;
        } else {
          show("<strong>Erfolg:</strong> Bestellung erfasst, aber keine redirectUrl erhalten.", "success");
        }
      } catch (err) {
        show("<strong>Netzwerkfehler:</strong> " + err.message, "error");
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
